<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提醒事項應用程式</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FFF8F0; /* 暖色調背景：非常淺的桃色/米色 */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 600px;
            width: 100%;
            background-color: #FFFFFF; /* 容器背景：白色，可與暖色調協調 */
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        input[type="date"],
        input[type="time"],
        input[type="text"],
        button {
            padding: 12px 18px;
            border-radius: 8px; /* Rounded corners for inputs/buttons */
            border: 1px solid #E0D4C1; /* 暖色調邊框：淺米色/棕褐色 */
            font-size: 16px;
            color: #4A4A4A; /* 暖色調深灰文字 */
            transition: all 0.2s ease-in-out;
        }
        input:focus,
        button:focus {
            outline: none;
            border-color: #D97940; /* 暖色調焦點環：焦橙色 */
            box-shadow: 0 0 0 3px rgba(217, 121, 64, 0.25);
        }
        button {
            cursor: pointer;
            background-color: #D97940; /* 暖色調按鈕：焦橙色 */
            color: white;
            font-weight: 600;
            border: none;
        }
        button:hover {
            background-color: #C06A3A; /* 滑鼠懸停時更深的焦橙色 */
            transform: translateY(-1px); /* Slight lift effect */
        }
        .reminder-item {
            background-color: #FFFCF9; /* 提醒事項背景：米白色 */
            border: 1px solid #E0D4C1; /* 與輸入框邊框相同 */
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            word-break: break-word; /* Ensure long text wraps */
        }
        .reminder-item strong {
            color: #4A4A4A; /* 暖色調深灰文字 */
        }
        .reminder-item span {
            color: #7A7A7A; /* 暖色調中灰文字 */
            font-size: 0.9em;
        }
        .delete-btn {
            background-color: #ef4444; /* 紅色刪除按鈕，保持警示性 */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.2s ease-in-out;
        }
        .delete-btn:hover {
            background-color: #dc2626;
            transform: scale(1.05);
        }
        .notification-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0; /* Start hidden */
            pointer-events: none; /* Disable pointer events when hidden */
            transition: opacity 0.3s ease-in-out;
        }
        .notification-modal.active {
            opacity: 1;
            pointer-events: auto;
        }
        .notification-content {
            background-color: #ffffff;
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 400px;
            width: 90%;
            transform: translateY(-20px); /* Slight initial lift */
            transition: transform 0.3s ease-in-out;
        }
        .notification-modal.active .notification-content {
            transform: translateY(0);
        }
        .notification-content h2 {
            font-size: 2em;
            color: #D97940; /* 提醒標題使用暖色調 */
            margin-bottom: 15px;
            font-weight: 700;
        }
        .notification-content p {
            font-size: 1.2em;
            color: #4A4A4A; /* 提醒內容使用暖色調深灰 */
            margin-bottom: 25px;
        }
        .notification-content button {
            background-color: #D97940; /* 提醒按鈕與主要按鈕顏色相同 */
            padding: 12px 25px;
            font-size: 1em;
        }
        .user-id-display {
            font-size: 0.8em;
            color: #7A7A7A; /* 用戶 ID 顯示為中灰 */
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            background-color: #F5EFE3; /* 用戶 ID 背景使用淺米色 */
            border-radius: 8px;
            word-break: break-all; /* Allow breaking long user IDs */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">我的提醒事項</h1>

        <div class="input-section flex flex-col gap-4">
            <div>
                <label for="reminderDate" class="block text-sm font-medium text-gray-700 mb-1">日期:</label>
                <input type="date" id="reminderDate" class="w-full">
            </div>
            <div>
                <label for="reminderTime" class="block text-sm font-medium text-gray-700 mb-1">時間:</label>
                <input type="time" id="reminderTime" class="w-full">
            </div>
            <div>
                <label for="reminderEvent" class="block text-sm font-medium text-gray-700 mb-1">事件:</label>
                <input type="text" id="reminderEvent" placeholder="輸入提醒事件..." class="w-full">
            </div>
            <button id="addReminderBtn" class="w-full">新增提醒</button>
        </div>

        <div class="reminders-list-section mt-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">待辦提醒</h2>
            <div id="remindersList" class="flex flex-col gap-3">
                <!-- Reminders will be loaded here -->
                <p class="text-gray-500 text-center" id="noRemindersMessage">目前沒有提醒事項。</p>
            </div>
        </div>

        <div class="user-id-display">
            <p>你的用戶 ID: <span id="currentUserId">載入中...</span></p>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="notification-modal hidden">
        <div class="notification-content">
            <h2 class="text-indigo-600">提醒!</h2>
            <p id="notificationMessage">這是一個提醒。</p>
            <button id="closeNotificationBtn">我知道了</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and user
        let app;
        let db;
        let auth;
        let userId;
        let reminders = []; // Array to store reminder objects
        const scheduledTimeouts = new Map(); // Map to store timeout IDs for clearing

        // DOM element references
        const reminderDateInput = document.getElementById('reminderDate');
        const reminderTimeInput = document.getElementById('reminderTime');
        const reminderEventInput = document.getElementById('reminderEvent');
        const addReminderBtn = document.getElementById('addReminderBtn');
        const remindersList = document.getElementById('remindersList');
        const noRemindersMessage = document.getElementById('noRemindersMessage');
        const notificationModal = document.getElementById('notificationModal');
        const notificationMessage = document.getElementById('notificationMessage');
        const closeNotificationBtn = document.getElementById('closeNotificationBtn');
        const currentUserIdSpan = document.getElementById('currentUserId');

        // Initialize Firebase and set up authentication
        async function initializeFirebase() {
            try {
                // Get app ID and Firebase config from global variables
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                // Initialize Firebase app
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        currentUserIdSpan.textContent = userId;
                        console.log("Firebase initialized. User ID:", userId);
                        setupFirestoreListener(); // Start listening for reminders once authenticated
                    } else {
                        // If user is signed out, create a random ID. This should ideally not happen if signInAnonymously succeeds.
                        userId = crypto.randomUUID();
                        currentUserIdSpan.textContent = `匿名用戶 (${userId})`;
                        console.log("Firebase initialized. Anonymous User ID:", userId);
                        setupFirestoreListener(); // Still try to load data, though it might be empty
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                // Display an error message to the user if Firebase initialization fails
                currentUserIdSpan.textContent = `載入失敗 (${error.message})`;
            }
        }

        // Set up real-time listener for reminders from Firestore
        function setupFirestoreListener() {
            if (!userId) {
                console.warn("User ID not available yet for Firestore listener.");
                return;
            }
            const remindersCollectionRef = collection(db, `artifacts/${__app_id}/users/${userId}/reminders`);
            // Use onSnapshot to listen for real-time updates
            onSnapshot(remindersCollectionRef, (snapshot) => {
                const newReminders = [];
                snapshot.forEach((doc) => {
                    newReminders.push({ id: doc.id, ...doc.data() });
                });

                // Clear all previously scheduled timeouts
                scheduledTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                scheduledTimeouts.clear();

                reminders = newReminders.sort((a, b) => a.timestamp - b.timestamp); // Sort by timestamp
                renderReminders();
                reminders.forEach(scheduleReminder); // Reschedule all reminders
            }, (error) => {
                console.error("Error fetching reminders:", error);
            });
        }

        // Function to add a new reminder
        async function addReminder() {
            const dateStr = reminderDateInput.value;
            const timeStr = reminderTimeInput.value;
            const eventText = reminderEventInput.value.trim();

            if (!dateStr || !timeStr || !eventText) {
                // 使用自定義模態框代替 alert
                showCustomModal("請填寫日期、時間和事件內容！");
                return;
            }

            // Combine date and time to create a Date object
            const reminderDateTime = new Date(`${dateStr}T${timeStr}`);
            const now = new Date();

            if (reminderDateTime.getTime() <= now.getTime()) {
                // 使用自定義模態框代替 alert
                showCustomModal("提醒時間必須晚於現在！");
                return;
            }

            const newReminder = {
                event: eventText,
                date: dateStr,
                time: timeStr,
                timestamp: reminderDateTime.getTime(), // Store timestamp for easy sorting and scheduling
                createdAt: Date.now() // For potential future sorting or debugging
            };

            try {
                // Add the reminder to Firestore
                const docRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/reminders`), newReminder);
                console.log("Reminder added with ID: ", docRef.id);

                // Clear input fields
                reminderDateInput.value = '';
                reminderTimeInput.value = '';
                reminderEventInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                // 使用自定義模態框代替 alert
                showCustomModal("新增提醒失敗，請檢查網路連線或稍後再試。");
            }
        }

        // Function to render the list of reminders
        function renderReminders() {
            remindersList.innerHTML = ''; // Clear existing list
            if (reminders.length === 0) {
                noRemindersMessage.style.display = 'block';
            } else {
                noRemindersMessage.style.display = 'none';
                reminders.forEach(reminder => {
                    const reminderItem = document.createElement('div');
                    reminderItem.className = 'reminder-item';
                    reminderItem.innerHTML = `
                        <div>
                            <strong>${reminder.event}</strong><br>
                            <span>${reminder.date} ${reminder.time}</span>
                        </div>
                        <button class="delete-btn" data-id="${reminder.id}">刪除</button>
                    `;
                    remindersList.appendChild(reminderItem);
                });
            }
        }

        // Function to schedule a single reminder
        function scheduleReminder(reminder) {
            const now = Date.now();
            const delay = reminder.timestamp - now;

            if (delay > 0) {
                const timeoutId = setTimeout(() => {
                    showNotification(reminder);
                    // Optionally, delete the reminder after it pops up
                    // deleteReminder(reminder.id);
                }, delay);
                scheduledTimeouts.set(reminder.id, timeoutId);
            } else {
                // If reminder is already past, remove it from list or mark as complete
                console.log(`Reminder for "${reminder.event}" is already past. Consider removing.`);
                // For this app, we'll keep it in the list until manually deleted.
            }
        }

        // Function to show the notification modal
        function showNotification(reminder) {
            notificationMessage.textContent = `「${reminder.event}」於 ${reminder.date} ${reminder.time} 到期了！`;
            notificationModal.classList.remove('hidden');
            notificationModal.classList.add('active');

            // Play a sound (optional)
            const audio = new Audio('https://www.soundjay.com/buttons/beep-07.mp3'); // Example sound, use with caution for production
            audio.play().catch(e => console.error("Error playing sound:", e));
        }

        // Function to show a custom modal for alert messages (replaces native alert)
        function showCustomModal(message) {
            const customModal = document.createElement('div');
            customModal.className = 'notification-modal active'; // Reuse notification modal styling
            customModal.innerHTML = `
                <div class="notification-content">
                    <h2 class="text-orange-600">注意!</h2>
                    <p>${message}</p>
                    <button id="customModalCloseBtn">確認</button>
                </div>
            `;
            document.body.appendChild(customModal);

            const customModalCloseBtn = customModal.querySelector('#customModalCloseBtn');
            customModalCloseBtn.addEventListener('click', () => {
                customModal.classList.remove('active');
                setTimeout(() => customModal.remove(), 300); // Remove after transition
            });
        }

        // Function to delete a reminder
        async function deleteReminder(id) {
            try {
                // Clear the scheduled timeout if it exists
                if (scheduledTimeouts.has(id)) {
                    clearTimeout(scheduledTimeouts.get(id));
                    scheduledTimeouts.delete(id);
                }

                // Delete from Firestore
                await deleteDoc(doc(db, `artifacts/${__app_id}/users/${userId}/reminders`, id));
                console.log("Reminder successfully deleted!");

                // onSnapshot listener will automatically re-render
            } catch (e) {
                console.error("Error removing document: ", e);
                // 使用自定義模態框代替 alert
                showCustomModal("刪除提醒失敗，請檢查網路連線或稍後再試。");
            }
        }

        // Event listeners
        addReminderBtn.addEventListener('click', addReminder);
        closeNotificationBtn.addEventListener('click', () => {
            notificationModal.classList.add('hidden');
            notificationModal.classList.remove('active');
        });

        // Event delegation for delete buttons in the list
        remindersList.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-btn')) {
                const reminderId = event.target.dataset.id;
                deleteReminder(reminderId);
            }
        });

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
